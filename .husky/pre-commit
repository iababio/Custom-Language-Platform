# Run lint-staged for formatting and linting
echo "🔍 Running linters and formatters..."
pnpm test
pnpm exec lint-staged

# Store the lint-staged exit status
LINT_STATUS=$?
if [ $LINT_STATUS -ne 0 ]; then
  echo "❌ Linting failed! Please fix the issues before committing."
  exit 1
fi

# Run Jest tests for changed files
echo "🧪 Running tests for changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx)$')

if [ -n "$CHANGED_FILES" ]; then
  # Only run tests if there are JavaScript/TypeScript files changed
  # Convert the file list to proper arguments for Jest
  # We use xargs to convert the newline-separated list to space-separated arguments
  echo "$CHANGED_FILES" | xargs pnpm test -- --bail --findRelatedTests
  
  # Store the test exit status
  TEST_STATUS=$?
  
  if [ $TEST_STATUS -ne 0 ]; then
    echo "❌ Tests failed! Please fix the failing tests before committing."
    exit 1
  fi
fi

echo "✅ All checks passed!"